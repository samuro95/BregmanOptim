

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vanilla Unfolded algorithm for super-resolution &mdash; deepinverse 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=d2d258e8" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css?v=f4aeca0c" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />

  
    <link rel="shortcut icon" href="../../_static/logo.ico"/>
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=2709fde1"></script>
      <script src="../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../_static/copybutton.js?v=35a8b989"></script>
      <script>window.MathJax = {"tex": {"equationNumbers": {"autoNumber": "AMS", "useLabelIds": true}, "macros": {"forw": ["{A\\left({#1}\\right)}", 1], "noise": ["{N\\left({#1}\\right)}", 1], "inverse": ["{R\\left({#1}\\right)}", 1], "inversef": ["{R\\left({#1},{#2}\\right)}", 2], "reg": ["{g_\\sigma\\left({#1}\\right)}", 1], "regname": "g_\\sigma", "sensor": ["{\\eta\\left({#1}\\right)}", 1], "datafid": ["{f\\left({#1},{#2}\\right)}", 2], "datafidname": "f", "distance": ["{d\\left({#1},{#2}\\right)}", 2], "distancename": "d", "denoiser": ["{\\operatorname{D}_{{#2}}\\left({#1}\\right)}", 2], "denoisername": "\\operatorname{D}_{\\sigma}", "xset": "\\mathcal{X}", "yset": "\\mathcal{Y}", "group": "\\mathcal{G}", "metric": ["{d\\left({#1},{#2}\\right)}", 2], "loss": ["{\\mathcal\\left({#1}\\right)}", 1], "conj": ["{\\overline{#1}^{\\top}}", 1]}}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Learned iterative custom prior" href="demo_custom_prior_unfolded.html" />
    <link rel="prev" title="Learned Iterative Soft-Thresholding Algorithm (LISTA) for compressed sensing" href="demo_LISTA.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/deepinv_logolarge.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../deepinv.physics.html">Physics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deepinv.datasets.html">Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deepinv.utils.html">Utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deepinv.loss.html">Loss</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deepinv.metric.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deepinv.transform.html">Transforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deepinv.denoisers.html">Denoisers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deepinv.optim.html">Optim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deepinv.iterative.html">Iterative Reconstruction (PnP, RED, etc.)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deepinv.unfolded.html">Unfolded Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deepinv.sampling.html">Diffusion Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deepinv.other_models.html">Other Reconstruction Methods</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#advanced">Advanced</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#adversarial-learning">Adversarial Learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#basics">Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#optimization">Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#patch-priors">Patch Priors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#plug-and-play">Plug-and-Play</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#sampling">Sampling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#self-supervised-learning">Self-Supervised Learning</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#unfolded">Unfolded</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="demo_LISTA.html">Learned Iterative Soft-Thresholding Algorithm (LISTA) for compressed sensing</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Vanilla Unfolded algorithm for super-resolution</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#setup-paths-for-data-loading-and-results">Setup paths for data loading and results.</a></li>
<li class="toctree-l4"><a class="reference internal" href="#load-base-image-datasets-and-degradation-operators">Load base image datasets and degradation operators.</a></li>
<li class="toctree-l4"><a class="reference internal" href="#generate-a-dataset-of-low-resolution-images-and-load-it">Generate a dataset of low resolution images and load it.</a></li>
<li class="toctree-l4"><a class="reference internal" href="#define-the-unfolded-pnp-algorithm">Define the unfolded PnP algorithm.</a></li>
<li class="toctree-l4"><a class="reference internal" href="#define-the-training-parameters">Define the training parameters.</a></li>
<li class="toctree-l4"><a class="reference internal" href="#train-the-network">Train the network</a></li>
<li class="toctree-l4"><a class="reference internal" href="#test-the-network">Test the network</a></li>
<li class="toctree-l4"><a class="reference internal" href="#plotting-the-weights-of-the-network">Plotting the weights of the network.</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="demo_custom_prior_unfolded.html">Learned iterative custom prior</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_DEQ.html">Deep Equilibrium (DEQ) algorithms for image deblurring</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_learned_primal_dual.html">Learned Primal-Dual algorithm for CT scan.</a></li>
<li class="toctree-l3"><a class="reference internal" href="demo_unfolded_constrained_LISTA.html">Unfolded Chambolle-Pock for constrained image inpainting</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../deepinv.multigpu.html">Using multiple GPUs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deepinv.notation.html">Math Notation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deepinv.contributing.html">How to Contribute</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: white" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">deepinverse</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Examples</a></li>
      <li class="breadcrumb-item active">Vanilla Unfolded algorithm for super-resolution</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/auto_examples/unfolded/demo_vanilla_unfolded.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-auto-examples-unfolded-demo-vanilla-unfolded-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code.</p>
</div>
<section class="sphx-glr-example-title" id="vanilla-unfolded-algorithm-for-super-resolution">
<span id="sphx-glr-auto-examples-unfolded-demo-vanilla-unfolded-py"></span><h1>Vanilla Unfolded algorithm for super-resolution<a class="headerlink" href="#vanilla-unfolded-algorithm-for-super-resolution" title="Link to this heading"></a></h1>
<p>This is a simple example to show how to use vanilla unfolded Plug-and-Play.
The DnCNN denoiser and the algorithm parameters (stepsize, regularization parameters) are trained jointly.
For simplicity, we show how to train the algorithm on a  small dataset. For optimal results, use a larger dataset.
For visualizing the training, you can use Weight&amp;Bias (wandb) by setting <code class="docutils literal notranslate"><span class="pre">wandb_vis=True</span></code>.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">deepinv</span> <span class="k">as</span> <span class="nn">dinv</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <a href="https://docs.python.org/3.4/library/pathlib.html#pathlib.Path" title="pathlib.Path" class="sphx-glr-backref-module-pathlib sphx-glr-backref-type-py-class"><span class="n">Path</span></a>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <a href="http://pytorch.org/docs/2.0/data.html#torch.utils.data.DataLoader" title="torch.utils.data.DataLoader" class="sphx-glr-backref-module-torch-utils-data sphx-glr-backref-type-py-class"><span class="n">DataLoader</span></a>
<span class="kn">from</span> <span class="nn">deepinv.optim.data_fidelity</span> <span class="kn">import</span> <a href="http://pytorch.org/docs/2.0/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">L2</span></a>
<span class="kn">from</span> <span class="nn">deepinv.optim.prior</span> <span class="kn">import</span> <a href="http://pytorch.org/docs/2.0/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">PnP</span></a>
<span class="kn">from</span> <span class="nn">deepinv.unfolded</span> <span class="kn">import</span> <span class="n">unfolded_builder</span>
<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span>
<span class="kn">from</span> <span class="nn">deepinv.utils.demo</span> <span class="kn">import</span> <span class="n">load_dataset</span>
</pre></div>
</div>
<section id="setup-paths-for-data-loading-and-results">
<h2>Setup paths for data loading and results.<a class="headerlink" href="#setup-paths-for-data-loading-and-results" title="Link to this heading"></a></h2>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><a href="https://docs.python.org/3.4/library/pathlib.html#pathlib.PosixPath" title="pathlib.PosixPath" class="sphx-glr-backref-module-pathlib sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">BASE_DIR</span></a> <span class="o">=</span> <a href="https://docs.python.org/3.4/library/pathlib.html#pathlib.Path" title="pathlib.Path" class="sphx-glr-backref-module-pathlib sphx-glr-backref-type-py-class"><span class="n">Path</span></a><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
<a href="https://docs.python.org/3.4/library/pathlib.html#pathlib.PosixPath" title="pathlib.PosixPath" class="sphx-glr-backref-module-pathlib sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ORIGINAL_DATA_DIR</span></a> <span class="o">=</span> <a href="https://docs.python.org/3.4/library/pathlib.html#pathlib.PosixPath" title="pathlib.PosixPath" class="sphx-glr-backref-module-pathlib sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">BASE_DIR</span></a> <span class="o">/</span> <span class="s2">&quot;datasets&quot;</span>
<a href="https://docs.python.org/3.4/library/pathlib.html#pathlib.PosixPath" title="pathlib.PosixPath" class="sphx-glr-backref-module-pathlib sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">DATA_DIR</span></a> <span class="o">=</span> <a href="https://docs.python.org/3.4/library/pathlib.html#pathlib.PosixPath" title="pathlib.PosixPath" class="sphx-glr-backref-module-pathlib sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">BASE_DIR</span></a> <span class="o">/</span> <span class="s2">&quot;measurements&quot;</span>
<a href="https://docs.python.org/3.4/library/pathlib.html#pathlib.PosixPath" title="pathlib.PosixPath" class="sphx-glr-backref-module-pathlib sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">RESULTS_DIR</span></a> <span class="o">=</span> <a href="https://docs.python.org/3.4/library/pathlib.html#pathlib.PosixPath" title="pathlib.PosixPath" class="sphx-glr-backref-module-pathlib sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">BASE_DIR</span></a> <span class="o">/</span> <span class="s2">&quot;results&quot;</span>
<a href="https://docs.python.org/3.4/library/pathlib.html#pathlib.PosixPath" title="pathlib.PosixPath" class="sphx-glr-backref-module-pathlib sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">CKPT_DIR</span></a> <span class="o">=</span> <a href="https://docs.python.org/3.4/library/pathlib.html#pathlib.PosixPath" title="pathlib.PosixPath" class="sphx-glr-backref-module-pathlib sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">BASE_DIR</span></a> <span class="o">/</span> <span class="s2">&quot;ckpts&quot;</span>

<span class="c1"># Set the global random seed from pytorch to ensure reproducibility of the example.</span>
<a href="http://pytorch.org/docs/2.0/generated/torch.manual_seed.html#torch.manual_seed" title="torch.manual_seed" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span></a><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">device</span></a> <span class="o">=</span> <span class="n">dinv</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_freer_gpu</span><span class="p">()</span> <span class="k">if</span> <a href="http://pytorch.org/docs/2.0/generated/torch.cuda.is_available.html#torch.cuda.is_available" title="torch.cuda.is_available" class="sphx-glr-backref-module-torch-cuda sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span></a><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span>
</pre></div>
</div>
</section>
<section id="load-base-image-datasets-and-degradation-operators">
<h2>Load base image datasets and degradation operators.<a class="headerlink" href="#load-base-image-datasets-and-degradation-operators" title="Link to this heading"></a></h2>
<p>In this example, we use the CBSD500 dataset for training and the Set3C dataset for testing.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">img_size</span></a> <span class="o">=</span> <span class="mi">64</span> <span class="k">if</span> <a href="http://pytorch.org/docs/2.0/generated/torch.cuda.is_available.html#torch.cuda.is_available" title="torch.cuda.is_available" class="sphx-glr-backref-module-torch-cuda sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span></a><span class="p">()</span> <span class="k">else</span> <span class="mi">32</span>
<a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">n_channels</span></a> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># 3 for color images, 1 for gray-scale images</span>
<a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">operation</span></a> <span class="o">=</span> <span class="s2">&quot;super-resolution&quot;</span>
</pre></div>
</div>
</section>
<section id="generate-a-dataset-of-low-resolution-images-and-load-it">
<h2>Generate a dataset of low resolution images and load it.<a class="headerlink" href="#generate-a-dataset-of-low-resolution-images-and-load-it" title="Link to this heading"></a></h2>
<p>We use the Downsampling class from the physics module to generate a dataset of low resolution images.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># For simplicity, we use a small dataset for training.</span>
<span class="c1"># To be replaced for optimal results. For example, you can use the larger &quot;drunet&quot; dataset.</span>
<a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">train_dataset_name</span></a> <span class="o">=</span> <span class="s2">&quot;CBSD500&quot;</span>
<a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">test_dataset_name</span></a> <span class="o">=</span> <span class="s2">&quot;set3c&quot;</span>
<span class="c1"># Specify the  train and test transforms to be applied to the input images.</span>
<span class="n">test_transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
    <span class="p">[</span><a href="http://pytorch.org/docs/2.0/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">transforms</span><span class="o">.</span><span class="n">CenterCrop</span></a><span class="p">(</span><a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">img_size</span></a><span class="p">),</span> <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()]</span>
<span class="p">)</span>
<span class="n">train_transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
    <span class="p">[</span><a href="http://pytorch.org/docs/2.0/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">transforms</span><span class="o">.</span><span class="n">RandomCrop</span></a><span class="p">(</span><a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">img_size</span></a><span class="p">),</span> <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()]</span>
<span class="p">)</span>
<span class="c1"># Define the base train and test datasets of clean images.</span>
<span class="n">train_base_dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span>
    <a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">train_dataset_name</span></a><span class="p">,</span> <a href="https://docs.python.org/3.4/library/pathlib.html#pathlib.PosixPath" title="pathlib.PosixPath" class="sphx-glr-backref-module-pathlib sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ORIGINAL_DATA_DIR</span></a><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">train_transform</span>
<span class="p">)</span>
<span class="n">test_base_dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span>
    <a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">test_dataset_name</span></a><span class="p">,</span> <a href="https://docs.python.org/3.4/library/pathlib.html#pathlib.PosixPath" title="pathlib.PosixPath" class="sphx-glr-backref-module-pathlib sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">ORIGINAL_DATA_DIR</span></a><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">test_transform</span>
<span class="p">)</span>

<span class="c1"># Use parallel dataloader if using a GPU to fasten training, otherwise, as all computes are on CPU, use synchronous</span>
<span class="c1"># dataloading.</span>
<a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">num_workers</span></a> <span class="o">=</span> <span class="mi">4</span> <span class="k">if</span> <a href="http://pytorch.org/docs/2.0/generated/torch.cuda.is_available.html#torch.cuda.is_available" title="torch.cuda.is_available" class="sphx-glr-backref-module-torch-cuda sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span></a><span class="p">()</span> <span class="k">else</span> <span class="mi">0</span>

<span class="c1"># Degradation parameters</span>
<a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">factor</span></a> <span class="o">=</span> <span class="mi">2</span>
<a href="https://docs.python.org/3.4/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">noise_level_img</span></a> <span class="o">=</span> <span class="mf">0.03</span>

<span class="c1"># Generate the gaussian blur downsampling operator.</span>
<span class="n">physics</span> <span class="o">=</span> <a href="http://pytorch.org/docs/2.0/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">dinv</span><span class="o">.</span><span class="n">physics</span><span class="o">.</span><span class="n">Downsampling</span></a><span class="p">(</span>
    <span class="nb">filter</span><span class="o">=</span><span class="s2">&quot;gaussian&quot;</span><span class="p">,</span>
    <a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">img_size</span></a><span class="o">=</span><span class="p">(</span><a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">n_channels</span></a><span class="p">,</span> <a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">img_size</span></a><span class="p">,</span> <a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">img_size</span></a><span class="p">),</span>
    <a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">factor</span></a><span class="o">=</span><a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">factor</span></a><span class="p">,</span>
    <a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">device</span></a><span class="o">=</span><a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">device</span></a><span class="p">,</span>
    <span class="n">noise_model</span><span class="o">=</span><a href="http://pytorch.org/docs/2.0/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">dinv</span><span class="o">.</span><span class="n">physics</span><span class="o">.</span><span class="n">GaussianNoise</span></a><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><a href="https://docs.python.org/3.4/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">noise_level_img</span></a><span class="p">),</span>
<span class="p">)</span>
<a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">my_dataset_name</span></a> <span class="o">=</span> <span class="s2">&quot;demo_unfolded_sr&quot;</span>
<a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">n_images_max</span></a> <span class="o">=</span> <span class="p">(</span>
    <span class="mi">1000</span> <span class="k">if</span> <a href="http://pytorch.org/docs/2.0/generated/torch.cuda.is_available.html#torch.cuda.is_available" title="torch.cuda.is_available" class="sphx-glr-backref-module-torch-cuda sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span></a><span class="p">()</span> <span class="k">else</span> <span class="mi">10</span>
<span class="p">)</span>  <span class="c1"># maximal number of images used for training</span>
<a href="https://docs.python.org/3.4/library/pathlib.html#pathlib.PosixPath" title="pathlib.PosixPath" class="sphx-glr-backref-module-pathlib sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">measurement_dir</span></a> <span class="o">=</span> <a href="https://docs.python.org/3.4/library/pathlib.html#pathlib.PosixPath" title="pathlib.PosixPath" class="sphx-glr-backref-module-pathlib sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">DATA_DIR</span></a> <span class="o">/</span> <a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">train_dataset_name</span></a> <span class="o">/</span> <a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">operation</span></a>
<a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">generated_datasets_path</span></a> <span class="o">=</span> <span class="n">dinv</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">generate_dataset</span><span class="p">(</span>
    <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_base_dataset</span><span class="p">,</span>
    <span class="n">test_dataset</span><span class="o">=</span><span class="n">test_base_dataset</span><span class="p">,</span>
    <span class="n">physics</span><span class="o">=</span><span class="n">physics</span><span class="p">,</span>
    <a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">device</span></a><span class="o">=</span><a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">device</span></a><span class="p">,</span>
    <span class="n">save_dir</span><span class="o">=</span><a href="https://docs.python.org/3.4/library/pathlib.html#pathlib.PosixPath" title="pathlib.PosixPath" class="sphx-glr-backref-module-pathlib sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">measurement_dir</span></a><span class="p">,</span>
    <span class="n">train_datapoints</span><span class="o">=</span><a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">n_images_max</span></a><span class="p">,</span>
    <a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">num_workers</span></a><span class="o">=</span><a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">num_workers</span></a><span class="p">,</span>
    <span class="n">dataset_filename</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">my_dataset_name</span></a><span class="p">),</span>
<span class="p">)</span>

<span class="n">train_dataset</span> <span class="o">=</span> <a href="http://pytorch.org/docs/2.0/data.html#torch.utils.data.Dataset" title="torch.utils.data.Dataset" class="sphx-glr-backref-module-torch-utils-data sphx-glr-backref-type-py-class"><span class="n">dinv</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">HDF5Dataset</span></a><span class="p">(</span><span class="n">path</span><span class="o">=</span><a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">generated_datasets_path</span></a><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">test_dataset</span> <span class="o">=</span> <a href="http://pytorch.org/docs/2.0/data.html#torch.utils.data.Dataset" title="torch.utils.data.Dataset" class="sphx-glr-backref-module-torch-utils-data sphx-glr-backref-type-py-class"><span class="n">dinv</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">HDF5Dataset</span></a><span class="p">(</span><span class="n">path</span><span class="o">=</span><a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">generated_datasets_path</span></a><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Downloading datasets/CBSD500.zip

  0%|          | 0.00/71.0M [00:00&lt;?, ?iB/s]
  0%|          | 327k/71.0M [00:00&lt;00:22, 3.14MiB/s]
  1%|          | 687k/71.0M [00:00&lt;00:20, 3.38MiB/s]
  1%|▏         | 1.03M/71.0M [00:00&lt;00:21, 3.23MiB/s]
  2%|▏         | 1.36M/71.0M [00:00&lt;00:21, 3.23MiB/s]
  2%|▏         | 1.68M/71.0M [00:00&lt;00:21, 3.22MiB/s]
  3%|▎         | 2.01M/71.0M [00:00&lt;00:21, 3.15MiB/s]
  3%|▎         | 2.37M/71.0M [00:00&lt;00:20, 3.27MiB/s]
  4%|▍         | 2.75M/71.0M [00:00&lt;00:19, 3.42MiB/s]
  4%|▍         | 3.16M/71.0M [00:00&lt;00:18, 3.63MiB/s]
  5%|▌         | 3.57M/71.0M [00:01&lt;00:17, 3.76MiB/s]
  6%|▌         | 4.00M/71.0M [00:01&lt;00:17, 3.89MiB/s]
  6%|▋         | 4.46M/71.0M [00:01&lt;00:16, 4.07MiB/s]
  7%|▋         | 4.88M/71.0M [00:01&lt;00:16, 4.08MiB/s]
  7%|▋         | 5.29M/71.0M [00:01&lt;00:16, 3.95MiB/s]
  8%|▊         | 5.69M/71.0M [00:01&lt;00:17, 3.67MiB/s]
  9%|▊         | 6.06M/71.0M [00:01&lt;00:17, 3.65MiB/s]
  9%|▉         | 6.43M/71.0M [00:01&lt;00:17, 3.59MiB/s]
 10%|▉         | 6.79M/71.0M [00:01&lt;00:18, 3.47MiB/s]
 10%|█         | 7.14M/71.0M [00:02&lt;00:18, 3.41MiB/s]
 11%|█         | 7.49M/71.0M [00:02&lt;00:18, 3.41MiB/s]
 11%|█         | 7.86M/71.0M [00:02&lt;00:18, 3.48MiB/s]
 12%|█▏        | 8.26M/71.0M [00:02&lt;00:17, 3.58MiB/s]
 12%|█▏        | 8.63M/71.0M [00:02&lt;00:17, 3.62MiB/s]
 13%|█▎        | 9.00M/71.0M [00:02&lt;00:17, 3.50MiB/s]
 13%|█▎        | 9.44M/71.0M [00:02&lt;00:16, 3.73MiB/s]
 14%|█▍        | 9.81M/71.0M [00:02&lt;00:16, 3.70MiB/s]
 14%|█▍        | 10.2M/71.0M [00:02&lt;00:17, 3.55MiB/s]
 15%|█▍        | 10.5M/71.0M [00:02&lt;00:17, 3.54MiB/s]
 15%|█▌        | 10.9M/71.0M [00:03&lt;00:16, 3.57MiB/s]
 16%|█▌        | 11.3M/71.0M [00:03&lt;00:16, 3.55MiB/s]
 16%|█▋        | 11.7M/71.0M [00:03&lt;00:16, 3.67MiB/s]
 17%|█▋        | 12.1M/71.0M [00:03&lt;00:16, 3.65MiB/s]
 18%|█▊        | 12.4M/71.0M [00:03&lt;00:16, 3.62MiB/s]
 18%|█▊        | 12.8M/71.0M [00:03&lt;00:16, 3.53MiB/s]
 19%|█▊        | 13.2M/71.0M [00:03&lt;00:16, 3.59MiB/s]
 19%|█▉        | 13.6M/71.0M [00:03&lt;00:15, 3.64MiB/s]
 20%|█▉        | 14.0M/71.0M [00:03&lt;00:15, 3.79MiB/s]
 20%|██        | 14.4M/71.0M [00:03&lt;00:14, 3.79MiB/s]
 21%|██        | 14.8M/71.0M [00:04&lt;00:15, 3.64MiB/s]
 21%|██▏       | 15.1M/71.0M [00:04&lt;00:15, 3.58MiB/s]
 22%|██▏       | 15.5M/71.0M [00:04&lt;00:15, 3.65MiB/s]
 22%|██▏       | 15.9M/71.0M [00:04&lt;00:14, 3.73MiB/s]
 23%|██▎       | 16.3M/71.0M [00:04&lt;00:14, 3.73MiB/s]
 23%|██▎       | 16.7M/71.0M [00:04&lt;00:14, 3.71MiB/s]
 24%|██▍       | 17.0M/71.0M [00:04&lt;00:14, 3.61MiB/s]
 25%|██▍       | 17.4M/71.0M [00:04&lt;00:14, 3.66MiB/s]
 25%|██▌       | 17.8M/71.0M [00:04&lt;00:14, 3.62MiB/s]
 26%|██▌       | 18.2M/71.0M [00:05&lt;00:14, 3.67MiB/s]
 26%|██▌       | 18.5M/71.0M [00:05&lt;00:14, 3.64MiB/s]
 27%|██▋       | 18.9M/71.0M [00:05&lt;00:14, 3.51MiB/s]
 27%|██▋       | 19.3M/71.0M [00:05&lt;00:14, 3.59MiB/s]
 28%|██▊       | 19.6M/71.0M [00:05&lt;00:14, 3.45MiB/s]
 28%|██▊       | 20.0M/71.0M [00:05&lt;00:14, 3.46MiB/s]
 29%|██▊       | 20.4M/71.0M [00:05&lt;00:14, 3.41MiB/s]
 29%|██▉       | 20.7M/71.0M [00:05&lt;00:15, 3.35MiB/s]
 30%|██▉       | 21.1M/71.0M [00:05&lt;00:14, 3.39MiB/s]
 30%|███       | 21.4M/71.0M [00:05&lt;00:14, 3.44MiB/s]
 31%|███       | 21.8M/71.0M [00:06&lt;00:14, 3.46MiB/s]
 31%|███       | 22.2M/71.0M [00:06&lt;00:13, 3.51MiB/s]
 32%|███▏      | 22.5M/71.0M [00:06&lt;00:13, 3.51MiB/s]
 32%|███▏      | 22.9M/71.0M [00:06&lt;00:13, 3.51MiB/s]
 33%|███▎      | 23.2M/71.0M [00:06&lt;00:13, 3.45MiB/s]
 33%|███▎      | 23.6M/71.0M [00:06&lt;00:13, 3.43MiB/s]
 34%|███▎      | 23.9M/71.0M [00:06&lt;00:14, 3.32MiB/s]
 34%|███▍      | 24.2M/71.0M [00:06&lt;00:14, 3.23MiB/s]
 35%|███▍      | 24.6M/71.0M [00:06&lt;00:13, 3.34MiB/s]
 35%|███▌      | 24.9M/71.0M [00:07&lt;00:13, 3.34MiB/s]
 36%|███▌      | 25.3M/71.0M [00:07&lt;00:13, 3.33MiB/s]
 36%|███▌      | 25.6M/71.0M [00:07&lt;00:13, 3.28MiB/s]
 37%|███▋      | 26.0M/71.0M [00:07&lt;00:13, 3.32MiB/s]
 37%|███▋      | 26.3M/71.0M [00:07&lt;00:13, 3.40MiB/s]
 38%|███▊      | 26.7M/71.0M [00:07&lt;00:13, 3.38MiB/s]
 38%|███▊      | 27.0M/71.0M [00:07&lt;00:12, 3.41MiB/s]
 39%|███▊      | 27.3M/71.0M [00:07&lt;00:12, 3.36MiB/s]
 39%|███▉      | 27.7M/71.0M [00:07&lt;00:12, 3.35MiB/s]
 40%|███▉      | 28.1M/71.0M [00:07&lt;00:12, 3.46MiB/s]
 40%|████      | 28.4M/71.0M [00:08&lt;00:11, 3.56MiB/s]
 41%|████      | 28.8M/71.0M [00:08&lt;00:11, 3.56MiB/s]
 41%|████      | 29.2M/71.0M [00:08&lt;00:11, 3.62MiB/s]
 42%|████▏     | 29.5M/71.0M [00:08&lt;00:11, 3.55MiB/s]
 42%|████▏     | 29.9M/71.0M [00:08&lt;00:11, 3.55MiB/s]
 43%|████▎     | 30.3M/71.0M [00:08&lt;00:11, 3.55MiB/s]
 43%|████▎     | 30.6M/71.0M [00:08&lt;00:11, 3.46MiB/s]
 44%|████▎     | 31.0M/71.0M [00:08&lt;00:11, 3.38MiB/s]
 44%|████▍     | 31.3M/71.0M [00:08&lt;00:11, 3.33MiB/s]
 45%|████▍     | 31.7M/71.0M [00:08&lt;00:11, 3.32MiB/s]
 45%|████▌     | 32.0M/71.0M [00:09&lt;00:11, 3.42MiB/s]
 46%|████▌     | 32.4M/71.0M [00:09&lt;00:11, 3.46MiB/s]
 46%|████▌     | 32.8M/71.0M [00:09&lt;00:11, 3.46MiB/s]
 47%|████▋     | 33.1M/71.0M [00:09&lt;00:10, 3.47MiB/s]
 47%|████▋     | 33.5M/71.0M [00:09&lt;00:11, 3.40MiB/s]
 48%|████▊     | 33.8M/71.0M [00:09&lt;00:10, 3.41MiB/s]
 48%|████▊     | 34.2M/71.0M [00:09&lt;00:10, 3.43MiB/s]
 49%|████▊     | 34.6M/71.0M [00:09&lt;00:10, 3.50MiB/s]
 49%|████▉     | 35.0M/71.0M [00:09&lt;00:09, 3.61MiB/s]
 50%|████▉     | 35.4M/71.0M [00:10&lt;00:09, 3.67MiB/s]
 50%|█████     | 35.8M/71.0M [00:10&lt;00:09, 3.75MiB/s]
 51%|█████     | 36.2M/71.0M [00:10&lt;00:09, 3.82MiB/s]
 52%|█████▏    | 36.6M/71.0M [00:10&lt;00:08, 3.89MiB/s]
 52%|█████▏    | 37.0M/71.0M [00:10&lt;00:08, 3.94MiB/s]
 53%|█████▎    | 37.4M/71.0M [00:10&lt;00:08, 3.96MiB/s]
 53%|█████▎    | 37.8M/71.0M [00:10&lt;00:08, 3.90MiB/s]
 54%|█████▍    | 38.2M/71.0M [00:10&lt;00:08, 3.94MiB/s]
 54%|█████▍    | 38.6M/71.0M [00:10&lt;00:08, 3.76MiB/s]
 55%|█████▍    | 39.0M/71.0M [00:10&lt;00:08, 3.72MiB/s]
 55%|█████▌    | 39.4M/71.0M [00:11&lt;00:08, 3.69MiB/s]
 56%|█████▌    | 39.7M/71.0M [00:11&lt;00:08, 3.69MiB/s]
 57%|█████▋    | 40.1M/71.0M [00:11&lt;00:08, 3.68MiB/s]
 57%|█████▋    | 40.5M/71.0M [00:11&lt;00:08, 3.66MiB/s]
 58%|█████▊    | 40.8M/71.0M [00:11&lt;00:08, 3.66MiB/s]
 58%|█████▊    | 41.2M/71.0M [00:11&lt;00:08, 3.71MiB/s]
 59%|█████▊    | 41.6M/71.0M [00:11&lt;00:07, 3.74MiB/s]
 59%|█████▉    | 42.0M/71.0M [00:11&lt;00:07, 3.73MiB/s]
 60%|█████▉    | 42.4M/71.0M [00:11&lt;00:07, 3.79MiB/s]
 60%|██████    | 42.8M/71.0M [00:11&lt;00:07, 3.78MiB/s]
 61%|██████    | 43.2M/71.0M [00:12&lt;00:07, 3.79MiB/s]
 61%|██████▏   | 43.6M/71.0M [00:12&lt;00:07, 3.87MiB/s]
 62%|██████▏   | 44.0M/71.0M [00:12&lt;00:07, 3.79MiB/s]
 62%|██████▏   | 44.3M/71.0M [00:12&lt;00:07, 3.76MiB/s]
 63%|██████▎   | 44.7M/71.0M [00:12&lt;00:07, 3.71MiB/s]
 64%|██████▎   | 45.1M/71.0M [00:12&lt;00:07, 3.55MiB/s]
 64%|██████▍   | 45.5M/71.0M [00:12&lt;00:07, 3.63MiB/s]
 65%|██████▍   | 45.9M/71.0M [00:12&lt;00:06, 3.71MiB/s]
 65%|██████▌   | 46.3M/71.0M [00:12&lt;00:06, 3.75MiB/s]
 66%|██████▌   | 46.6M/71.0M [00:13&lt;00:06, 3.75MiB/s]
 66%|██████▋   | 47.0M/71.0M [00:13&lt;00:06, 3.78MiB/s]
 67%|██████▋   | 47.4M/71.0M [00:13&lt;00:06, 3.78MiB/s]
 67%|██████▋   | 47.8M/71.0M [00:13&lt;00:06, 3.79MiB/s]
 68%|██████▊   | 48.2M/71.0M [00:13&lt;00:05, 3.87MiB/s]
 68%|██████▊   | 48.6M/71.0M [00:13&lt;00:06, 3.68MiB/s]
 69%|██████▉   | 49.0M/71.0M [00:13&lt;00:06, 3.63MiB/s]
 70%|██████▉   | 49.3M/71.0M [00:13&lt;00:05, 3.69MiB/s]
 70%|███████   | 49.8M/71.0M [00:13&lt;00:05, 3.77MiB/s]
 71%|███████   | 50.1M/71.0M [00:13&lt;00:05, 3.72MiB/s]
 71%|███████   | 50.5M/71.0M [00:14&lt;00:05, 3.74MiB/s]
 72%|███████▏  | 50.9M/71.0M [00:14&lt;00:05, 3.65MiB/s]
 72%|███████▏  | 51.3M/71.0M [00:14&lt;00:05, 3.66MiB/s]
 73%|███████▎  | 51.7M/71.0M [00:14&lt;00:05, 3.67MiB/s]
 73%|███████▎  | 52.1M/71.0M [00:14&lt;00:05, 3.77MiB/s]
 74%|███████▍  | 52.4M/71.0M [00:14&lt;00:04, 3.77MiB/s]
 74%|███████▍  | 52.9M/71.0M [00:14&lt;00:04, 3.86MiB/s]
 75%|███████▌  | 53.3M/71.0M [00:14&lt;00:04, 3.91MiB/s]
 76%|███████▌  | 53.7M/71.0M [00:14&lt;00:04, 3.95MiB/s]
 76%|███████▌  | 54.1M/71.0M [00:14&lt;00:04, 4.01MiB/s]
 77%|███████▋  | 54.5M/71.0M [00:15&lt;00:04, 4.05MiB/s]
 77%|███████▋  | 54.9M/71.0M [00:15&lt;00:03, 4.04MiB/s]
 78%|███████▊  | 55.4M/71.0M [00:15&lt;00:03, 4.08MiB/s]
 79%|███████▊  | 55.8M/71.0M [00:15&lt;00:03, 4.05MiB/s]
 79%|███████▉  | 56.2M/71.0M [00:15&lt;00:03, 4.02MiB/s]
 80%|███████▉  | 56.6M/71.0M [00:15&lt;00:03, 3.96MiB/s]
 80%|████████  | 57.0M/71.0M [00:15&lt;00:03, 3.66MiB/s]
 81%|████████  | 57.3M/71.0M [00:15&lt;00:03, 3.67MiB/s]
 81%|████████▏ | 57.7M/71.0M [00:15&lt;00:03, 3.65MiB/s]
 82%|████████▏ | 58.1M/71.0M [00:16&lt;00:03, 3.66MiB/s]
 82%|████████▏ | 58.5M/71.0M [00:16&lt;00:03, 3.69MiB/s]
 83%|████████▎ | 58.8M/71.0M [00:16&lt;00:03, 3.64MiB/s]
 83%|████████▎ | 59.2M/71.0M [00:16&lt;00:03, 3.58MiB/s]
 84%|████████▍ | 59.6M/71.0M [00:16&lt;00:03, 3.64MiB/s]
 85%|████████▍ | 60.0M/71.0M [00:16&lt;00:02, 3.67MiB/s]
 85%|████████▌ | 60.4M/71.0M [00:16&lt;00:02, 3.62MiB/s]
 86%|████████▌ | 60.7M/71.0M [00:16&lt;00:02, 3.70MiB/s]
 86%|████████▌ | 61.2M/71.0M [00:16&lt;00:02, 3.82MiB/s]
 87%|████████▋ | 61.6M/71.0M [00:16&lt;00:02, 3.83MiB/s]
 87%|████████▋ | 61.9M/71.0M [00:17&lt;00:02, 3.74MiB/s]
 88%|████████▊ | 62.3M/71.0M [00:17&lt;00:02, 3.65MiB/s]
 88%|████████▊ | 62.7M/71.0M [00:17&lt;00:02, 3.69MiB/s]
 89%|████████▉ | 63.1M/71.0M [00:17&lt;00:02, 3.73MiB/s]
 89%|████████▉ | 63.5M/71.0M [00:17&lt;00:01, 3.81MiB/s]
 90%|█████████ | 63.9M/71.0M [00:17&lt;00:01, 3.86MiB/s]
 91%|█████████ | 64.3M/71.0M [00:17&lt;00:01, 3.95MiB/s]
 91%|█████████ | 64.7M/71.0M [00:17&lt;00:01, 3.94MiB/s]
 92%|█████████▏| 65.1M/71.0M [00:17&lt;00:01, 3.63MiB/s]
 92%|█████████▏| 65.5M/71.0M [00:18&lt;00:01, 3.57MiB/s]
 93%|█████████▎| 65.9M/71.0M [00:18&lt;00:01, 3.57MiB/s]
 93%|█████████▎| 66.3M/71.0M [00:18&lt;00:01, 3.76MiB/s]
 94%|█████████▍| 66.7M/71.0M [00:18&lt;00:01, 3.78MiB/s]
 95%|█████████▍| 67.1M/71.0M [00:18&lt;00:01, 3.67MiB/s]
 95%|█████████▌| 67.5M/71.0M [00:18&lt;00:00, 3.60MiB/s]
 96%|█████████▌| 67.8M/71.0M [00:18&lt;00:00, 3.58MiB/s]
 96%|█████████▌| 68.2M/71.0M [00:18&lt;00:00, 3.58MiB/s]
 97%|█████████▋| 68.6M/71.0M [00:18&lt;00:00, 3.75MiB/s]
 97%|█████████▋| 69.1M/71.0M [00:18&lt;00:00, 3.94MiB/s]
 98%|█████████▊| 69.5M/71.0M [00:19&lt;00:00, 4.03MiB/s]
 98%|█████████▊| 69.9M/71.0M [00:19&lt;00:00, 4.03MiB/s]
 99%|█████████▉| 70.3M/71.0M [00:19&lt;00:00, 4.05MiB/s]
100%|█████████▉| 70.7M/71.0M [00:19&lt;00:00, 4.05MiB/s]
100%|██████████| 71.0M/71.0M [00:19&lt;00:00, 3.65MiB/s]
CBSD500 dataset downloaded in datasets
Downloading datasets/set3c.zip

  0%|          | 0.00/385k [00:00&lt;?, ?iB/s]
100%|██████████| 385k/385k [00:00&lt;00:00, 26.5MiB/s]
set3c dataset downloaded in datasets
Dataset has been saved in measurements/CBSD500/super-resolution
</pre></div>
</div>
</section>
<section id="define-the-unfolded-pnp-algorithm">
<h2>Define the unfolded PnP algorithm.<a class="headerlink" href="#define-the-unfolded-pnp-algorithm" title="Link to this heading"></a></h2>
<p>We use the helper function <a class="reference internal" href="../../stubs/deepinv.unfolded.unfolded_builder.html#deepinv.unfolded.unfolded_builder" title="deepinv.unfolded.unfolded_builder"><code class="xref py py-meth docutils literal notranslate"><span class="pre">deepinv.unfolded.unfolded_builder()</span></code></a> to defined the Unfolded architecture.
The chosen algorithm is here DRS (Douglas-Rachford Splitting).
Note that if the prior (resp. a parameter) is initialized with a list of lenght max_iter,
then a distinct model (resp. parameter) is trained for each iteration.
For fixed trained model prior (resp. parameter) across iterations, initialize with a single element.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Unrolled optimization algorithm parameters</span>
<a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">max_iter</span></a> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># number of unfolded layers</span>

<span class="c1"># Select the data fidelity term</span>
<span class="n">data_fidelity</span> <span class="o">=</span> <a href="http://pytorch.org/docs/2.0/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">L2</span></a><span class="p">()</span>

<span class="c1"># Set up the trainable denoising prior</span>
<span class="c1"># Here the prior model is common for all iterations</span>
<span class="n">prior</span> <span class="o">=</span> <a href="http://pytorch.org/docs/2.0/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">PnP</span></a><span class="p">(</span><span class="n">denoiser</span><span class="o">=</span><a href="http://pytorch.org/docs/2.0/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">dinv</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">DnCNN</span></a><span class="p">(</span><span class="n">depth</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">device</span></a><span class="p">))</span>

<span class="c1"># The parameters are initialized with a list of length max_iter, so that a distinct parameter is trained for each iteration.</span>
<a href="https://docs.python.org/3.4/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">stepsize</span></a> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">max_iter</span></a>  <span class="c1"># stepsize of the algorithm</span>
<a href="https://docs.python.org/3.4/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">sigma_denoiser</span></a> <span class="o">=</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">]</span> <span class="o">*</span> <a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">max_iter</span></a>  <span class="c1"># noise level parameter of the denoiser</span>
<a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">beta</span></a> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># relaxation parameter of the Douglas-Rachford splitting</span>
<a href="https://docs.python.org/3.4/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">params_algo</span></a> <span class="o">=</span> <span class="p">{</span>  <span class="c1"># wrap all the restoration parameters in a &#39;params_algo&#39; dictionary</span>
    <span class="s2">&quot;stepsize&quot;</span><span class="p">:</span> <a href="https://docs.python.org/3.4/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">stepsize</span></a><span class="p">,</span>
    <span class="s2">&quot;g_param&quot;</span><span class="p">:</span> <a href="https://docs.python.org/3.4/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">sigma_denoiser</span></a><span class="p">,</span>
    <span class="s2">&quot;beta&quot;</span><span class="p">:</span> <a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">beta</span></a><span class="p">,</span>
<span class="p">}</span>
<a href="https://docs.python.org/3.4/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">trainable_params</span></a> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;g_param&quot;</span><span class="p">,</span>
    <span class="s2">&quot;stepsize&quot;</span><span class="p">,</span>
    <span class="s2">&quot;beta&quot;</span><span class="p">,</span>
<span class="p">]</span>  <span class="c1"># define which parameters from &#39;params_algo&#39; are trainable</span>

<span class="c1"># Logging parameters</span>
<a href="https://docs.python.org/3.4/library/functions.html#bool" title="builtins.bool" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">verbose</span></a> <span class="o">=</span> <span class="kc">True</span>
<a href="https://docs.python.org/3.4/library/functions.html#bool" title="builtins.bool" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">wandb_vis</span></a> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># plot curves and images in Weight&amp;Bias</span>

<span class="c1"># Define the unfolded trainable model.</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">unfolded_builder</span><span class="p">(</span>
    <span class="n">iteration</span><span class="o">=</span><span class="s2">&quot;DRS&quot;</span><span class="p">,</span>
    <a href="https://docs.python.org/3.4/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">params_algo</span></a><span class="o">=</span><a href="https://docs.python.org/3.4/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">params_algo</span></a><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
    <a href="https://docs.python.org/3.4/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">trainable_params</span></a><span class="o">=</span><a href="https://docs.python.org/3.4/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">trainable_params</span></a><span class="p">,</span>
    <span class="n">data_fidelity</span><span class="o">=</span><span class="n">data_fidelity</span><span class="p">,</span>
    <a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">max_iter</span></a><span class="o">=</span><a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">max_iter</span></a><span class="p">,</span>
    <span class="n">prior</span><span class="o">=</span><span class="n">prior</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="define-the-training-parameters">
<h2>Define the training parameters.<a class="headerlink" href="#define-the-training-parameters" title="Link to this heading"></a></h2>
<p>We use the Adam optimizer and the StepLR scheduler.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># training parameters</span>
<a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">epochs</span></a> <span class="o">=</span> <span class="mi">10</span> <span class="k">if</span> <a href="http://pytorch.org/docs/2.0/generated/torch.cuda.is_available.html#torch.cuda.is_available" title="torch.cuda.is_available" class="sphx-glr-backref-module-torch-cuda sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span></a><span class="p">()</span> <span class="k">else</span> <span class="mi">2</span>
<a href="https://docs.python.org/3.4/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">learning_rate</span></a> <span class="o">=</span> <span class="mf">5e-4</span>
<a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">train_batch_size</span></a> <span class="o">=</span> <span class="mi">32</span> <span class="k">if</span> <a href="http://pytorch.org/docs/2.0/generated/torch.cuda.is_available.html#torch.cuda.is_available" title="torch.cuda.is_available" class="sphx-glr-backref-module-torch-cuda sphx-glr-backref-type-py-function"><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span></a><span class="p">()</span> <span class="k">else</span> <span class="mi">1</span>
<a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">test_batch_size</span></a> <span class="o">=</span> <span class="mi">3</span>

<span class="c1"># choose optimizer and scheduler</span>
<a href="http://pytorch.org/docs/2.0/generated/torch.optim.Adam.html#torch.optim.Adam" title="torch.optim.Adam" class="sphx-glr-backref-module-torch-optim sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">optimizer</span></a> <span class="o">=</span> <a href="http://pytorch.org/docs/2.0/generated/torch.optim.Adam.html#torch.optim.Adam" title="torch.optim.Adam" class="sphx-glr-backref-module-torch-optim sphx-glr-backref-type-py-class"><span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span></a><span class="p">(</span><a href="http://pytorch.org/docs/2.0/generated/torch.nn.Module.html#torch.nn.Module.parameters" title="torch.nn.Module.parameters" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-method"><span class="n">model</span><span class="o">.</span><span class="n">parameters</span></a><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><a href="https://docs.python.org/3.4/library/functions.html#float" title="builtins.float" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">learning_rate</span></a><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">)</span>
<a href="http://pytorch.org/docs/2.0/generated/torch.optim.lr_scheduler.StepLR.html#torch.optim.lr_scheduler.StepLR" title="torch.optim.lr_scheduler.StepLR" class="sphx-glr-backref-module-torch-optim-lr_scheduler sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">scheduler</span></a> <span class="o">=</span> <a href="http://pytorch.org/docs/2.0/generated/torch.optim.lr_scheduler.StepLR.html#torch.optim.lr_scheduler.StepLR" title="torch.optim.lr_scheduler.StepLR" class="sphx-glr-backref-module-torch-optim-lr_scheduler sphx-glr-backref-type-py-class"><span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">StepLR</span></a><span class="p">(</span><a href="http://pytorch.org/docs/2.0/generated/torch.optim.Adam.html#torch.optim.Adam" title="torch.optim.Adam" class="sphx-glr-backref-module-torch-optim sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">optimizer</span></a><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">epochs</span></a> <span class="o">*</span> <span class="mf">0.8</span><span class="p">))</span>

<span class="c1"># choose supervised training loss</span>
<a href="https://docs.python.org/3.4/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">losses</span></a> <span class="o">=</span> <span class="p">[</span><a href="http://pytorch.org/docs/2.0/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">dinv</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">SupLoss</span></a><span class="p">(</span><span class="n">metric</span><span class="o">=</span><a href="http://pytorch.org/docs/2.0/generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-class"><span class="n">dinv</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">MSE</span></a><span class="p">())]</span>

<a href="http://pytorch.org/docs/2.0/data.html#torch.utils.data.DataLoader" title="torch.utils.data.DataLoader" class="sphx-glr-backref-module-torch-utils-data sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">train_dataloader</span></a> <span class="o">=</span> <a href="http://pytorch.org/docs/2.0/data.html#torch.utils.data.DataLoader" title="torch.utils.data.DataLoader" class="sphx-glr-backref-module-torch-utils-data sphx-glr-backref-type-py-class"><span class="n">DataLoader</span></a><span class="p">(</span>
    <span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">train_batch_size</span></a><span class="p">,</span> <a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">num_workers</span></a><span class="o">=</span><a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">num_workers</span></a><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<a href="http://pytorch.org/docs/2.0/data.html#torch.utils.data.DataLoader" title="torch.utils.data.DataLoader" class="sphx-glr-backref-module-torch-utils-data sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">test_dataloader</span></a> <span class="o">=</span> <a href="http://pytorch.org/docs/2.0/data.html#torch.utils.data.DataLoader" title="torch.utils.data.DataLoader" class="sphx-glr-backref-module-torch-utils-data sphx-glr-backref-type-py-class"><span class="n">DataLoader</span></a><span class="p">(</span>
    <span class="n">test_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">test_batch_size</span></a><span class="p">,</span> <a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">num_workers</span></a><span class="o">=</span><a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">num_workers</span></a><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="train-the-network">
<h2>Train the network<a class="headerlink" href="#train-the-network" title="Link to this heading"></a></h2>
<p>We train the network using the <a class="reference internal" href="../../stubs/deepinv.Trainer.html#deepinv.Trainer" title="deepinv.Trainer"><code class="xref py py-meth docutils literal notranslate"><span class="pre">deepinv.Trainer()</span></code></a> class.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">trainer</span> <span class="o">=</span> <span class="n">dinv</span><span class="o">.</span><span class="n">Trainer</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span>
    <span class="n">physics</span><span class="o">=</span><span class="n">physics</span><span class="p">,</span>
    <a href="http://pytorch.org/docs/2.0/data.html#torch.utils.data.DataLoader" title="torch.utils.data.DataLoader" class="sphx-glr-backref-module-torch-utils-data sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">train_dataloader</span></a><span class="o">=</span><a href="http://pytorch.org/docs/2.0/data.html#torch.utils.data.DataLoader" title="torch.utils.data.DataLoader" class="sphx-glr-backref-module-torch-utils-data sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">train_dataloader</span></a><span class="p">,</span>
    <span class="n">eval_dataloader</span><span class="o">=</span><a href="http://pytorch.org/docs/2.0/data.html#torch.utils.data.DataLoader" title="torch.utils.data.DataLoader" class="sphx-glr-backref-module-torch-utils-data sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">test_dataloader</span></a><span class="p">,</span>
    <a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">epochs</span></a><span class="o">=</span><a href="https://docs.python.org/3.4/library/functions.html#int" title="builtins.int" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">epochs</span></a><span class="p">,</span>
    <a href="http://pytorch.org/docs/2.0/generated/torch.optim.lr_scheduler.StepLR.html#torch.optim.lr_scheduler.StepLR" title="torch.optim.lr_scheduler.StepLR" class="sphx-glr-backref-module-torch-optim-lr_scheduler sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">scheduler</span></a><span class="o">=</span><a href="http://pytorch.org/docs/2.0/generated/torch.optim.lr_scheduler.StepLR.html#torch.optim.lr_scheduler.StepLR" title="torch.optim.lr_scheduler.StepLR" class="sphx-glr-backref-module-torch-optim-lr_scheduler sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">scheduler</span></a><span class="p">,</span>
    <a href="https://docs.python.org/3.4/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">losses</span></a><span class="o">=</span><a href="https://docs.python.org/3.4/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">losses</span></a><span class="p">,</span>
    <a href="http://pytorch.org/docs/2.0/generated/torch.optim.Adam.html#torch.optim.Adam" title="torch.optim.Adam" class="sphx-glr-backref-module-torch-optim sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">optimizer</span></a><span class="o">=</span><a href="http://pytorch.org/docs/2.0/generated/torch.optim.Adam.html#torch.optim.Adam" title="torch.optim.Adam" class="sphx-glr-backref-module-torch-optim sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">optimizer</span></a><span class="p">,</span>
    <a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">device</span></a><span class="o">=</span><a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">device</span></a><span class="p">,</span>
    <span class="n">save_path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><a href="https://docs.python.org/3.4/library/pathlib.html#pathlib.PosixPath" title="pathlib.PosixPath" class="sphx-glr-backref-module-pathlib sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">CKPT_DIR</span></a> <span class="o">/</span> <a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">operation</span></a><span class="p">),</span>
    <a href="https://docs.python.org/3.4/library/functions.html#bool" title="builtins.bool" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">verbose</span></a><span class="o">=</span><a href="https://docs.python.org/3.4/library/functions.html#bool" title="builtins.bool" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">verbose</span></a><span class="p">,</span>
    <span class="n">show_progress_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># disable progress bar for better vis in sphinx gallery.</span>
    <a href="https://docs.python.org/3.4/library/functions.html#bool" title="builtins.bool" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">wandb_vis</span></a><span class="o">=</span><a href="https://docs.python.org/3.4/library/functions.html#bool" title="builtins.bool" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">wandb_vis</span></a><span class="p">,</span>  <span class="c1"># training visualization can be done in Weight&amp;Bias</span>
<span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>The model has 188174 trainable parameters
Train epoch 0: TotalLoss=140.864, PSNR=-0.094
Eval epoch 0: PSNR=2.717
Train epoch 1: TotalLoss=0.276, PSNR=6.355
Eval epoch 1: PSNR=3.146
</pre></div>
</div>
</section>
<section id="test-the-network">
<h2>Test the network<a class="headerlink" href="#test-the-network" title="Link to this heading"></a></h2>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">trainer</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><a href="http://pytorch.org/docs/2.0/data.html#torch.utils.data.DataLoader" title="torch.utils.data.DataLoader" class="sphx-glr-backref-module-torch-utils-data sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">test_dataloader</span></a><span class="p">)</span>

<a href="http://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">test_sample</span></a><span class="p">,</span> <a href="http://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">_</span></a> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><a href="http://pytorch.org/docs/2.0/data.html#torch.utils.data.DataLoader" title="torch.utils.data.DataLoader" class="sphx-glr-backref-module-torch-utils-data sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">test_dataloader</span></a><span class="p">))</span>
<a href="http://pytorch.org/docs/2.0/generated/torch.nn.Module.html#torch.nn.Module.eval" title="torch.nn.Module.eval" class="sphx-glr-backref-module-torch-nn sphx-glr-backref-type-py-method"><span class="n">model</span><span class="o">.</span><span class="n">eval</span></a><span class="p">()</span>
<a href="http://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">test_sample</span></a> <span class="o">=</span> <a href="http://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">test_sample</span></a><span class="o">.</span><span class="n">to</span><span class="p">(</span><a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">device</span></a><span class="p">)</span>

<span class="c1"># Get the measurements and the ground truth</span>
<a href="http://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">y</span></a> <span class="o">=</span> <span class="n">physics</span><span class="p">(</span><a href="http://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">test_sample</span></a><span class="p">)</span>
<span class="k">with</span> <a href="http://pytorch.org/docs/2.0/generated/torch.no_grad.html#torch.no_grad" title="torch.no_grad" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class"><span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span></a><span class="p">():</span>
    <a href="http://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">rec</span></a> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><a href="http://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">y</span></a><span class="p">,</span> <span class="n">physics</span><span class="o">=</span><span class="n">physics</span><span class="p">)</span>

<a href="http://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">backprojected</span></a> <span class="o">=</span> <span class="n">physics</span><span class="o">.</span><span class="n">A_adjoint</span><span class="p">(</span><a href="http://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">y</span></a><span class="p">)</span>

<span class="n">dinv</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="p">[</span><a href="http://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">backprojected</span></a><span class="p">,</span> <a href="http://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">rec</span></a><span class="p">,</span> <a href="http://pytorch.org/docs/2.0/tensors.html#torch.Tensor" title="torch.Tensor" class="sphx-glr-backref-module-torch sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">test_sample</span></a><span class="p">],</span>
    <span class="n">titles</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Linear&quot;</span><span class="p">,</span> <span class="s2">&quot;Reconstruction&quot;</span><span class="p">,</span> <span class="s2">&quot;Ground truth&quot;</span><span class="p">],</span>
    <span class="n">suptitle</span><span class="o">=</span><span class="s2">&quot;Reconstruction results&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_demo_vanilla_unfolded_001.png" srcset="../../_images/sphx_glr_demo_vanilla_unfolded_001.png" alt="Reconstruction results, Linear, Reconstruction, Ground truth" class = "sphx-glr-single-img"/><div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Eval epoch 0: PSNR=3.146, PSNR no learning=5.996
Test results:
PSNR no learning: 5.996 +- 1.188
PSNR: 3.146 +- 1.309
</pre></div>
</div>
</section>
<section id="plotting-the-weights-of-the-network">
<h2>Plotting the weights of the network.<a class="headerlink" href="#plotting-the-weights-of-the-network" title="Link to this heading"></a></h2>
<p>We now plot the weights of the network that were learned and check that they are different from their initialization
values. Note that <code class="docutils literal notranslate"><span class="pre">g_param</span></code> corresponds to <span class="math notranslate nohighlight">\(\lambda\)</span> in the proximal gradient algorithm.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">dinv</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">plot_parameters</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span> <span class="n">init_params</span><span class="o">=</span><a href="https://docs.python.org/3.4/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">params_algo</span></a><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><a href="https://docs.python.org/3.4/library/pathlib.html#pathlib.PosixPath" title="pathlib.PosixPath" class="sphx-glr-backref-module-pathlib sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">RESULTS_DIR</span></a> <span class="o">/</span> <span class="s2">&quot;unfolded_pgd&quot;</span> <span class="o">/</span> <a href="https://docs.python.org/3.4/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">operation</span></a>
<span class="p">)</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_demo_vanilla_unfolded_002.png" srcset="../../_images/sphx_glr_demo_vanilla_unfolded_002.png" alt="demo vanilla unfolded" class = "sphx-glr-single-img"/><p class="sphx-glr-timing"><strong>Total running time of the script:</strong> (0 minutes 21.890 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-examples-unfolded-demo-vanilla-unfolded-py">
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/d413f127f8fcdc4f25ebe8912dc1f800/demo_vanilla_unfolded.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">demo_vanilla_unfolded.ipynb</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/aa635a7f9321b9a4a94be443b1752796/demo_vanilla_unfolded.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">demo_vanilla_unfolded.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-zip docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/5af3f2cac86b04c291e6c72d72b7d37a/demo_vanilla_unfolded.zip"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">zipped:</span> <span class="pre">demo_vanilla_unfolded.zip</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="demo_LISTA.html" class="btn btn-neutral float-left" title="Learned Iterative Soft-Thresholding Algorithm (LISTA) for compressed sensing" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="demo_custom_prior_unfolded.html" class="btn btn-neutral float-right" title="Learned iterative custom prior" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, DeepInv.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-NSEKFKYSGR"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-NSEKFKYSGR', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>